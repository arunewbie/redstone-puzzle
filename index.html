<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>RedStone Puzzle Game</title>
<link rel="icon" type="image/svg+xml" href="/images/logo-redstone.svg">
<style>
Â  :root{--primary:#ff1e00;--bg:#0b0b0f;--muted:#9aa0a6;--card:#13141a}
Â  *{box-sizing:border-box}
Â  body{
Â  Â  margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Inter,Arial;
Â  Â  background:url('/images/redstone-bg.png') center/cover fixed no-repeat;
Â  }
Â  body::before{content:'';position:fixed;inset:0;backdrop-filter:blur(8px);background:rgba(0,0,0,.45)}
Â  header{position:relative;z-index:1;text-align:center;padding:22px 16px 6px}
Â  h1{color:#fff;margin:0;display:flex;align-items:center;justify-content:center;gap:10px;font-weight:800;text-shadow:0 0 10px rgba(255,255,255,.25)}
Â  .title-logo{height:40px}
Â  .sub{color:var(--muted);font-size:14px}
Â  .wrap{position:relative;z-index:1;max-width:1080px;margin:20px auto;padding:0 16px;display:grid;grid-template-columns:1fr 360px;gap:18px}
Â  @media (max-width:960px){.wrap{grid-template-columns:1fr}}
Â  .card{background:var(--card);border:1px solid #1e2027;border-radius:18px;box-shadow:0 10px 30px rgba(0,0,0,.35)}
Â  .game{padding:16px}
Â  .board{position:relative;display:flex;justify-content:center;align-items:center;padding:8px}
Â  canvas#board{width:100%;max-width:560px;aspect-ratio:1/1;height:auto;background:#0b0c12;border:1px solid #242633;border-radius:14px;display:block}
Â  canvas#fx{position:absolute;inset:8px;max-width:560px;aspect-ratio:1/1;border-radius:14px;pointer-events:none}
Â  .side{padding:16px;display:grid;gap:12px}
Â  .panel{background:#0f1117;border:1px solid #1f232d;border-radius:14px;padding:14px}
Â  .panel h3{margin:0 0 8px;color:#e8eaee;font-size:15px}
Â  .row{display:flex;gap:8px;flex-wrap:wrap}
Â  input,select,button{border-radius:12px;border:1px solid #2a2f3a;background:#1d212b;color:#fff;padding:10px 12px}
Â  button{background:var(--primary);border:none;font-weight:700;cursor:pointer}
Â  button.secondary{background:#1d212b;border:1px solid #2a2f3a}
Â  button:disabled{opacity:.5;cursor:not-allowed}
Â  .badges{display:flex;gap:10px;flex-wrap:wrap;justify-content:center;margin-top:10px}
Â  .badge{background:#191b22;border:1px solid #252830;color:#d5d7dc;font-size:13px;border-radius:999px;padding:6px 10px}
Â  .ok{color:#66ef9a}
Â  .muted{color:#9aa0a6}
Â  .footer{color:#9aa0a6;text-align:center;padding:16px;position:relative;z-index:1}
Â  /* leaderboard */
Â  .list{display:grid;gap:6px;max-height:220px;overflow:auto}
Â  .leader{display:flex;justify-content:space-between;border-bottom:1px solid #21242c;padding:6px 0;font-size:14px;color:#d5dae0}
Â  .crown{margin-right:6px}
Â  /* win glow */
Â  .win-glow{animation:winGlow 1200ms ease-out 1}
Â  @keyframes winGlow{
Â  Â  0%{box-shadow:0 0 0 rgba(255,255,255,0)}
Â  Â  30%{box-shadow:0 0 40px rgba(255,255,255,.35)}
Â  Â  100%{box-shadow:0 0 0 rgba(255,255,255,0)}
Â  }
</style>
</head>
<body>
Â  <header>
Â  Â  <h1><img class="title-logo" src="/images/logo-redstone.svg" alt=""><span>RedStone Puzzle Game</span></h1>
Â  Â  <div class="sub">Drag the tiles to complete the image. Click/tap on the tiles next to the empty space.</div>
Â  </header>

Â  <main class="wrap">
Â  Â  <section class="card game">
Â  Â  Â  <div class="board" id="boardWrap">
Â  Â  Â  Â  <canvas id="board" width="560" height="560"></canvas>
Â  Â  Â  Â  <canvas id="fx" width="560" height="560"></canvas>
Â  Â  Â  </div>
Â  Â  Â  <div class="badges">
Â  Â  Â  Â  <div class="badge">Player: <b id="playerLabel">â€”</b></div>
Â  Â  Â  Â  <div class="badge">Moves: <b id="moves">0</b></div>
Â  Â  Â  Â  <div class="badge">Time: <b id="time">00:00</b></div>
Â  Â  Â  Â  <div class="badge">Grid: <b id="gridLabel">3Ã—3</b></div>
Â  Â  Â  Â  <div class="badge">Status: <b id="status" class="muted">Ready</b></div>
Â  Â  Â  </div>
Â  Â  </section>

Â  Â  <aside class="card side">
Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Player</h3>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <input id="username" placeholder="Your username..." />
Â  Â  Â  Â  Â  Â  <button id="saveName" class="secondary">Set</button>

Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Image</h3>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <select id="imageSelect">
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <option value="redstone1.png">RedStone1</option>
Â  Â  Â  Â  Â  <option value="redstone2.png">RedStone2</option>
Â  Â  Â  Â  Â  <option value="redstone3.png">RedStone3</option>
Â  Â  Â  Â  Â  <option value="redstone4.png">RedStone4</option>
Â  Â  Â  Â  Â  <option value="redstone5.png">RedStone5</option>
Â  Â  Â  Â  Â  <option value="redstone6.png">RedStone6</option>
Â  Â  Â  Â  Â  <option value="redstone7.png">RedStone7</option>
Â  Â  Â  Â  Â  <option value="atom.png">RedStone atom</option>
Â  Â  Â  Â  Â  <option value="redstonelogo.png">RedStone logo</option>
Â  Â  Â  Â  Â  <option value="stoney.png">Stoney</option>
Â  Â  Â  Â  Â  </select>
Â  Â  Â  Â  Â  <button id="reload" class="secondary">Load</button>
Â  Â  Â  Â  Â  Â  <button id="previewBtn">Preview</button>
Â  </div>
Â  <div id="previewContainer" style="margin-top:10px; display:none;">
Â  Â  <img id="previewImage" src="" alt="Preview Image" style="width:100%;border-radius:10px;border:1px solid #2a2f3a;">
Â  </div>
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â 
Â  Â  Â  Â  Â  <button id="shuffle">Shuffle</button>
Â  Â  Â  Â  Â 
Â  Â  Â  Â Â 
Â  Â  Â  Â  Â Â 
Â  Â  Â  Â  </div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>Controls</h3>
Â  Â  Â  Â  <div class="row">
Â  Â  Â  Â  Â  <button id="newGame">New Game</button>
Â  Â  Â  Â  Â <button id="shareX" class="secondary">Share on X</button>
<button onclick="previewShareCard()" class="secondary">Preview Card ğŸ–¼ï¸</button>
Â  Â  Â  Â  </div>
Â  Â  Â  Â  <div class="muted" style="font-size:13px;margin-top:6px">Share Your Best Score to X.</div>
Â  Â  Â  </div>

Â  Â  Â  <div class="panel">
Â  Â  Â  Â  <h3>ğŸ† Leaderboard (Best Time)</h3>
Â  Â  Â  Â  <div id="leaderboard" class="list"></div>
Â  Â  Â  </div>
Â  Â  </aside>
Â  </main>

Â  <div class="footer">Â© RedStone Puzzle Game by arunewbie </div>

<script>
/* ====== Core Sliding Puzzle with username + timer + leaderboard + share + win FX ====== */
const canvas = document.getElementById('board');
const ctx = canvas.getContext('2d');
const fx = document.getElementById('fx');
const fxctx = fx.getContext('2d');
const wrap = document.getElementById('boardWrap');

const movesEl = document.getElementById('moves');
const timeElÂ  = document.getElementById('time');
const gridLabel = document.getElementById('gridLabel');
const statusEl = document.getElementById('status');
const playerLabel = document.getElementById('playerLabel');

const usernameInput = document.getElementById('username');
const saveNameBtnÂ  Â = document.getElementById('saveName');

const imageSelect = document.getElementById('imageSelect');
const reloadBtnÂ  Â = document.getElementById('reload');
const gridSelectÂ  = document.getElementById('grid');
const shuffleBtnÂ  = document.getElementById('shuffle');
const newBtnÂ  Â  Â  = document.getElementById('newGame');
const shareBtnÂ  Â  = document.getElementById('shareX');

const IMAGE_BASE = '/images/';
let img = null;

const st = {
Â  n: 3,
Â  tiles: [],
Â  moves: 0,
Â  empty: 0,
Â  timer: null,
Â  startedAt: 0,
Â  username: localStorage.getItem('ps_username') || '',
};

playerLabel.textContent = st.username || 'â€”';
if (st.username) usernameInput.value = st.username;

function fmt(ms){
Â  const s = Math.floor(ms/1000), m = Math.floor(s/60), ss = s % 60;
Â  return String(m).padStart(2,'0') + ':' + String(ss).padStart(2,'0');
}
function startTimer(){ stopTimer(); st.startedAt = Date.now(); st.timer = setInterval(()=>{ timeEl.textContent = fmt(Date.now() - st.startedAt); }, 250); }
function stopTimer(){ if(st.timer){ clearInterval(st.timer); st.timer=null; } }

function resetOrderedBoard(){
Â  const n = st.n, N = n*n;
Â  st.tiles = Array.from({length:N}, (_,i)=>i);
Â  st.empty = N-1;
Â  st.moves = 0;
Â  stopTimer();
Â  st.startedAt = 0;
Â  movesEl.textContent = '0';
Â  timeEl.textContent = '00:00';
Â  statusEl.textContent = 'Ready';
Â  statusEl.classList.remove('ok');
Â  draw();
}

function shuffleSolvable(steps=200){
Â  const n = st.n, N = n*n;
Â  st.tiles = Array.from({length:N}, (_,i)=>i);
Â  st.empty = N-1;
Â  let last = -1;
Â  for (let k=0;k<steps;k++){
Â  Â  const e = st.empty, r = Math.floor(e/n), c = e % n;
Â  Â  const opt = [];
Â  Â  if (r>0) opt.push(e-n);
Â  Â  if (r<n-1) opt.push(e+n);
Â  Â  if (c>0) opt.push(e-1);
Â  Â  if (c<n-1) opt.push(e+1);
Â  Â  const filtered = opt.filter(x=>x!==last);
Â  Â  const pool = filtered.length ? filtered : opt;
Â  Â  const next = pool[Math.floor(Math.random()*pool.length)];
Â  Â  swap(e,next);
Â  Â  last = e;
Â  Â  st.empty = next;
Â  }
Â  st.moves = 0;
Â  movesEl.textContent = '0';
Â  timeEl.textContent = '00:00';
Â  statusEl.textContent = 'Playingâ€¦';
Â  statusEl.classList.remove('ok');
}

function swap(a,b){ const t = st.tiles[a]; st.tiles[a]=st.tiles[b]; st.tiles[b]=t; }
function isSolved(){ return st.tiles.every((v,i)=>v===i); }

function loadImage(name){
Â  return new Promise((resolve)=>{
Â  Â  const image = new Image();
Â  Â  image.onload = ()=>resolve(image);
Â  Â  image.onerror = ()=>resolve(null);
Â  Â  image.src = IMAGE_BASE + name + `?v=${Date.now()}`;
Â  });
}

function draw(){
Â  const n = st.n, N = n*n, tW = canvas.width/n, tH = canvas.height/n;
Â  ctx.clearRect(0,0,canvas.width,canvas.height);
Â  for (let i=0;i<N;i++){
Â  Â  const val = st.tiles[i];
Â  Â  const r = Math.floor(i/n), c = i % n;
Â  Â  if (val === N-1){
Â  Â  Â  ctx.fillStyle='#0b0c12';
Â  Â  Â  ctx.fillRect(c*tW, r*tH, tW, tH);
Â  Â  Â  continue;
Â  Â  }
Â  Â  const sR = Math.floor(val/n), sC = val % n;
Â  Â  ctx.drawImage(img, sC*(img.width/n), sR*(img.height/n), img.width/n, img.height/n, c*tW, r*tH, tW, tH);
Â  Â  ctx.strokeStyle='rgba(255,255,255,.075)';
Â  Â  ctx.strokeRect(c*tW+0.5, r*tH+0.5, tW-1, tH-1);
Â  }
}

function posToIdx(x,y){
Â  const n = st.n;
Â  const rect = canvas.getBoundingClientRect();
Â  const cx = (x-rect.left)*(canvas.width/rect.width);
Â  const cy = (y-rect.top)*(canvas.height/rect.height);
Â  const col = Math.floor(cx/(canvas.width/n));
Â  const row = Math.floor(cy/(canvas.height/n));
Â  return (col<0||row<0||col>=n||row>=n) ? -1 : row*n + col;
}


const previewBtn = document.getElementById('previewBtn');
const previewContainer = document.getElementById('previewContainer');
const previewImage = document.getElementById('previewImage');

previewBtn.addEventListener('click', () => {
Â  const imgName = imageSelect.value;
Â  if (!imgName) return;
Â  previewImage.src = IMAGE_BASE + imgName;
Â  previewContainer.style.display = 'block';
});

Â Â 
function canMove(i){
Â  const n = st.n, e = st.empty;
Â  const sr = Math.floor(i/n), sc = i%n, er = Math.floor(e/n), ec = e % n;
Â  return Math.abs(sr-er) + Math.abs(sc-ec) === 1;
}

function move(i){
Â  if (!canMove(i)) return;

Â  // lakukan perpindahan dulu
Â  swap(i, st.empty);
Â  st.empty = i;

Â  // mulai timer HANYA saat langkah efektif pertama
Â  if (!st.timer && !st.startedAt && st.moves === 0){
Â  Â  startTimer();
Â  Â  statusEl.textContent = 'Playingâ€¦';
Â  }

Â  st.moves++;
Â  movesEl.textContent = st.moves;
Â  draw();

Â  if (isSolved()){
Â  Â  onWin();
Â  }
}


/* ========= Leaderboard (API vercel) ========= */
async function saveScoreToServer(name, ms, moves){
Â  const res = await fetch('/api/leaderboard', {
Â  Â  method:'POST',
Â  Â  headers:{'content-type':'application/json'},
Â  Â  body: JSON.stringify({ name, time: ms, moves })
Â  });
Â  if (!res.ok) throw new Error('submit failed');
Â  return res.json();
}

async function fetchLeaderboard(){
Â  try{
Â  Â  const res = await fetch('/api/leaderboard');
Â  Â  if(!res.ok) throw new Error('GET failed');
Â  Â  return await res.json(); // [{name,time,moves}, ...]
Â  }catch{
Â  Â  // fallback baca localStorage jika perlu
Â  Â  return JSON.parse(localStorage.getItem('ps_leaderboard')||'[]');
Â  }
}

async function renderLeaderboard(){
Â  const el = document.getElementById('leaderboard');
Â  if(!el) return;
Â  el.innerHTML = '';
Â  const data = await fetchLeaderboard();
Â  (data||[]).forEach((e,i)=>{
Â  Â  const row = document.createElement('div');
Â  Â  row.className = 'leader';
Â  Â  row.innerHTML = `<span>${i===0?'ğŸ‘‘ ':''}${i+1}. ${e.name||'Anon'}</span>
Â  Â  Â  Â  Â  Â  Â  Â  Â  Â  Â <span>${fmt(Number(e.time||0))} â€¢ ${Number(e.moves||0)} mv</span>`;
Â  Â  el.appendChild(row);
Â  });
Â  if (!data || data.length===0){
Â  Â  el.innerHTML = '<div class="muted">Belum ada skor</div>';
Â  }
}

/* ===== Win FX (confetti simple + glow) ===== */
function confettiBurst(){
Â  fxctx.clearRect(0,0,fx.width,fx.height);
Â  const particles = [];
Â  const N = 120;
Â  for (let i=0;i<N;i++){
Â  Â  particles.push({
Â  Â  Â  x: fx.width/2, y: fx.height/2,
Â  Â  Â  vx: (Math.random()*2-1)*4,
Â  Â  Â  vy: (Math.random()*2-1)*4 - 2,
Â  Â  Â  g: 0.08 + Math.random()*0.06,
Â  Â  Â  life: 60 + Math.random()*20,
Â  Â  Â  size: 2 + Math.random()*3
Â  Â  });
Â  }
Â  let t=0;
Â  function tick(){
Â  Â  fxctx.clearRect(0,0,fx.width,fx.height);
Â  Â  particles.forEach(p=>{
Â  Â  Â  p.vy += p.g; p.x += p.vx; p.y += p.vy; p.life--;
Â  Â  Â  fxctx.globalAlpha = Math.max(0, p.life/80);
Â  Â  Â  fxctx.fillStyle = ['#ff1e00','#ffd166','#66ef9a','#66a0ff','#ffffff'][Math.floor(Math.random()*5)];
Â  Â  Â  fxctx.beginPath(); fxctx.arc(p.x,p.y,p.size,0,Math.PI*2); fxctx.fill();
Â  Â  });
Â  Â  fxctx.globalAlpha = 1;
Â  Â  t++;
Â  Â  if (t<90) requestAnimationFrame(tick);
Â  Â  else fxctx.clearRect(0,0,fx.width,fx.height);
Â  }
Â  tick();
Â  // glow anim on wrapper
Â  wrap.classList.remove('win-glow'); // restart animation
Â  void wrap.offsetWidth;
Â  wrap.classList.add('win-glow');
}

/* ====== SHARE CARD + SHARE ON X ====== */
function blobToFile(blob, name) {
Â  return new File([blob], name, { type: blob.type });
}

function loadExtImage(url) {
Â  return new Promise(resolve => {
Â  Â  const im = new Image();
Â  Â  im.crossOrigin = 'anonymous';
Â  Â  im.onload = () => resolve(im);
Â  Â  im.onerror = () => resolve(null);
Â  Â  im.src = url + (url.includes('?') ? '&' : '?') + 'v=' + Date.now();
Â  });
}

async function createShareCard(username, bestMs, moves) {
Â  const w = 1200, h = 630;
Â  const c = document.createElement('canvas');
Â  c.width = w; c.height = h;
Â  const g = c.getContext('2d');

Â  // background gradasi
Â  const grd = g.createLinearGradient(0, 0, w, h);
Â  grd.addColorStop(0, '#11131a');
Â  grd.addColorStop(1, '#1a0f0f');
Â  g.fillStyle = grd;
Â  g.fillRect(0, 0, w, h);

Â  // blob dekorasi
Â  g.globalAlpha = 0.22;
Â  g.fillStyle = '#ff1e00';
Â  g.beginPath(); g.arc(w * 0.85, h * 0.22, 160, 0, Math.PI * 2); g.fill();
Â  g.fillStyle = '#ffffff';
Â  g.beginPath(); g.arc(w * 0.18, h * 0.82, 220, 0, Math.PI * 2); g.fill();
Â  g.globalAlpha = 1;

Â  // logo RedStone
Â  try {
Â  Â  const logo = await loadExtImage('/images/redstonelogox.png');
Â  Â  if (logo) g.drawImage(logo, w - 300, 40, 300, 300);
Â  } catch {}

Â  // teks
Â  g.fillStyle = '#fff';
Â  g.font = '800 64px system-ui';
Â  g.fillText('RedStone Puzzle Game', 60, 120);

Â  g.font = '600 42px system-ui';
Â  g.fillStyle = '#cfd3da';
Â  g.fillText('Player', 60, 200);
Â  g.fillStyle = '#ffffff';
Â  g.font = '800 56px system-ui';
Â  g.fillText(username || 'Anon', 60, 258);

Â  g.fillStyle = '#cfd3da';
Â  g.font = '600 42px system-ui';
Â  g.fillText('Best Time', 60, 340);
Â  g.fillStyle = '#66ef9a';
Â  g.font = '800 88px system-ui';
Â  g.fillText(fmt(bestMs), 60, 410);

Â  g.fillStyle = '#cfd3da';
Â  g.font = '600 42px system-ui';
Â  g.fillText('Moves', 60, 490);
Â  g.fillStyle = '#66a0ff';
Â  g.font = '800 88px system-ui';
Â  g.fillText(String(moves), 60, 560);

Â  return new Promise(resolve => c.toBlob(b => resolve(b), 'image/png'));
}

async function shareOnX(username) {
Â  const name = username || 'Anon';
Â  const board = JSON.parse(localStorage.getItem('ps_leaderboard') || '[]');
Â  const my = board.find(e => e.name === name) || { time: 0, moves: 0 };
Â  const rank = Math.max(1, board.findIndex(e => e.name === name) + 1);

Â  const cardBlob = await createShareCard(name, my.time || 0, my.moves || 0);
Â  const file = blobToFile(cardBlob, 'puzzle-score.png');

Â  const caption =
Â  Â Â 
Â  Â  `ğŸ‘‘ ${name} just solved RedStone Puzzle!\n` +
Â  Â  `Rank #${rank} â€¢ â³ ${fmt(my.time || 0)} â€¢ ğŸ§© ${my.moves || 0} moves\n` +
Â  Â  `Can you beat this?`+
Â  ' @redstone_defi ' ;

Â  try {
Â  Â  if (navigator.canShare && navigator.canShare({ files: [file] })) {
Â  Â  Â  await navigator.share({
Â  Â  Â  Â  title: 'RedStone Puzzle Game',
Â  Â  Â  Â  text: caption,
Â  Â  Â  Â  files: [file],
Â  Â  Â  Â  url: location.origin
Â  Â  Â  });
Â  Â  Â  return;
Â  Â  }
Â  } catch (e) {}

Â  // fallback ke tweet intent
Â  const shareUrl =
Â  Â  `https://twitter.com/intent/tweet?text=${encodeURIComponent(caption)}&url=${encodeURIComponent(location.origin)}&hashtags=${encodeURIComponent('RedStone')}`;
Â  window.open(shareUrl, '_blank', 'noopener,noreferrer');
}

/* ==== Optional: tombol untuk cek preview card ==== */
async function previewShareCard(){
Â  const name = st.username || 'Anon';
Â  const board = JSON.parse(localStorage.getItem('ps_leaderboard') || '[]');
Â  const my = board.find(e => e.name === name) || { time: 0, moves: 0 };
Â  const blob = await createShareCard(name, my.time || 0, my.moves || 0);
Â  const url = URL.createObjectURL(blob);
Â  window.open(url, '_blank');
}


/* --- FUNGSI BARU: Pilih Gambar Acak --- */
function getRandomImageName() {
    // Ambil semua opsi gambar dari elemen <select>
    const options = Array.from(imageSelect.options);
    
    // Pilih indeks acak, hindari yang terpilih saat ini jika memungkinkan
    let randomIndex;
    do {
        randomIndex = Math.floor(Math.random() * options.length);
    } while (options.length > 1 && options[randomIndex].value === imageSelect.value);

    // Set nilai <select> ke gambar acak yang baru
    imageSelect.value = options[randomIndex].value;
    
    return imageSelect.value;
}
/* -------------------------------------- */


/* ===== Events ===== */
saveNameBtn.onclick = ()=>{
Â  const v = usernameInput.value.trim();
Â  st.username = v || 'Anon';
Â  localStorage.setItem('ps_username', st.username);
Â  playerLabel.textContent = st.username;
};


/* --- MODIFIKASI EVENT LISTENER TOMBOL LOAD (reloadBtn) --- */
reloadBtn.addEventListener('click', async ()=>{
Â  // 1. Pilih gambar acak
Â  const randomImageName = getRandomImageName();
Â  
Â  // 2. Muat gambar
Â  const loaded = await loadImage(randomImageName);
Â  if (!loaded){ alert('Image not found: '+randomImageName); return; }
Â  img = loaded;
Â  
Â  // 3. Reset board ke kondisi tersusun RAPI (tidak di-shuffle)
Â  resetOrderedBoard();
Â  
Â  // 4. Update status dan label
Â  statusEl.textContent = 'Ready to Shuffle'; // Ubah status agar jelas
Â  statusEl.classList.remove('ok');
});
/* -------------------------------------------------------- */


shuffleBtn.addEventListener('click', ()=>{
Â  if (!img) return;
Â  shuffleSolvable(Math.max(200, st.n*st.n*30));
Â  draw(); startTimer(); statusEl.textContent='Playingâ€¦';
});

newBtn.addEventListener('click', async ()=>{
Â  if (!img){
Â  Â  img = await loadImage(imageSelect.value);
Â  Â  if (!img){ alert('Image not found: '+imageSelect.value); return; }
Â  }
Â  shuffleSolvable(Math.max(200, st.n*st.n*30));
Â  draw(); startTimer(); statusEl.textContent='Playingâ€¦';
});

canvas.addEventListener('click', e=>{
Â  if (!img) return;
Â  const i = posToIdx(e.clientX, e.clientY);
Â  if (i>=0) move(i);
});
canvas.addEventListener('touchend', e=>{
Â  if (!img) return;
Â  const t = e.changedTouches[0];
Â  const i = posToIdx(t.clientX, t.clientY);
Â  if (i>=0) move(i);
},{passive:true});
window.addEventListener('keydown', e=>{
Â  if (!img) return;
Â  const n = st.n, eIdx = st.empty;
Â  let target = -1;
Â  const r = Math.floor(eIdx/n), c = eIdx % n;
Â  if (e.key==='ArrowUp' && r<n-1)Â  Â target = eIdx + n;
Â  if (e.key==='ArrowDown' && r>0)Â  Â target = eIdx - n;
Â  if (e.key==='ArrowLeft' && c<n-1) target = eIdx + 1;
Â  if (e.key==='ArrowRight'&& c>0)Â  Â target = eIdx - 1;
Â  if (target>=0) move(target);
});

shareBtn.onclick = () => shareOnX(st.username || 'Anon');



/* ========= WIN HANDLER ========= */
async function onWin(){
Â  stopTimer();
Â  statusEl.textContent='Solved!';
Â  statusEl.classList.add('ok');
Â  confettiBurst();

Â  const elapsed = Date.now() - st.startedAt;
Â  const name = (st.username || 'Anon').trim() || 'Anon';

Â  try{
Â  Â  await saveScoreToServer(name, elapsed, st.moves);
Â  }catch(e){
Â  Â  // fallback local kalau API gagal
Â  Â  let board = JSON.parse(localStorage.getItem('ps_leaderboard')||'[]');
Â  Â  board.push({ name, time: elapsed, moves: st.moves, date: Date.now() });
Â  Â  board.sort((a,b)=> (a.time - b.time) || (a.moves - b.moves));
Â  Â  board = board.slice(0,10);
Â  Â  localStorage.setItem('ps_leaderboard', JSON.stringify(board));
Â  }
Â  renderLeaderboard();
}

/* ========= INIT ========= */
(async function init(){
Â  // load default image, tapi JANGAN shuffle
Â  const loaded = await loadImage(imageSelect.value);
Â  if (loaded){
Â  Â  img = loaded;
Â  Â  resetOrderedBoard();
Â  } else {
Â  Â  statusEl.textContent = 'Select image & Load';
Â  }
Â  await renderLeaderboard();
})();
</script>
</body>
</html>
